---
import BaseLayout from "../layouts/baselayout.astro";

import { CONFIG } from "@config";

const gitHubUser = process.env.GITHUB_REPOSITORY_OWNER || CONFIG.EDITOR.GITHUBUSER;

const gitHubRepo = process.env.GITHUB_REPOSITORY && process.env.GITHUB_REPOSITORY.replace(gitHubUser+'/', '') || CONFIG.EDITOR.GITHUBREPO;

const postsCollection = import.meta.glob('../content/posts/*.{mdx, md}', {
  eager: true,
});

const allPosts = Object.entries(postsCollection).map(([key, val]) => ({url: val.url, data: val.frontmatter}))

const draftPosts = allPosts.filter( post => post.data.status === 'draft');

const publishedPosts = allPosts.filter( post => post.data.status === 'published');

const dataCollection = import.meta.glob('../data/*.{mdx, md}', {
  eager: true,
});

const allData = Object.entries(dataCollection).map(([key, val]) => ({url: val.url, data: val.frontmatter}))

const editUrl = (url) => `https://github.com/${gitHubUser}/${gitHubRepo}/edit/main/${url}`;

const uploadUrl = `https://github.com/${gitHubUser}/${gitHubRepo}/upload/main/src/media`;

const regex = /\/([^\/]+)\.mdx$/;

const dataFilename = (url) => url.match(regex)[1] || null;
---

<BaseLayout>
  <h1>Editor</h1>
  {publishedPosts.length>0 &&
    <section>
      <h2>Published Posts</h2>
      <ul>
        {publishedPosts.map(post => <li><a href={editUrl(post.url)} target="_blank">{post.data.title}</a></li> )}
      </ul>
    </section>
  }

{draftPosts.length>0 &&
  <section>
    <h2>Drafts</h2>
    <ul>
      {draftPosts.map(post => <li><a href={editUrl(post.url)} target="_blank">{post.data.title}</a></li> )}
    </ul>
  </section>
}

{allData.length>0 &&
  <section>
    <h2>Data</h2>
    <ul>
      {allData.map(data => <li><a href={editUrl(data.url)} target="_blank">{dataFilename(data.url)}</a></li> )}
    </ul>
  </section>
}
  
<section>
  <h2>Config</h2>
  <ul>
    <li><a href={editUrl('blog-config.yaml')} target="_blank">Config</a></li>
  </ul>
</section>

<section>
  <h2>Media</h2>
  <ul>
    <li><a href={uploadUrl} target="_blank">Upload files</a></li>
  </ul>
</section>

</BaseLayout>
