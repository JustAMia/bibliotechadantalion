---
import Parser from 'rss-parser';

import BlogRollItem from './blogroll-item.astro';

async function getRss(url: string) {
    const parser = new Parser();
    try {
        const feed = await parser.parseURL(url);
        return {success: true, title: feed.title, items: feed.items}
    } catch (err) {
        return { success: false, error: `error: ${err}`}
    }
}

const { urls } = Astro.props;

const blogroll = [];

for (const url of urls) {
    const rss = await getRss(url);

    if (!rss.success || !Array.isArray(rss.items) || rss.items.length ===0) {continue;}
    
    rss.items.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));

    const topItem = rss.items[0];

    if (topItem) {
        topItem.blogTitle = rss.title || null;
        blogroll.push(topItem)
    }
}

blogroll.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate))
        
---
<div class="blogroll-feed">
    {blogroll.map( blog => <BlogRollItem item={blog}/> )}
</div>
